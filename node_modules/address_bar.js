var events = require("events");
var path = require('path');
var util = require("util");
var jade = require('jade');

if (process.platform == 'win32') {
    var win32 = require("win32");
}

// Template engine
var gen_bar = jade.compile([
    '- each item, i in sequence',
    '  - if (i != sequence.length - 1)',
    '    li(data-path="#{item.path}")',
    '      a(href="#") #{item.name}',
    '      span.divider ' + path.sep,
    '  - else',
    '    li.active #{item.name}',
].join('\n'));

// Our real type
function AddressBar(element) {
    events.EventEmitter.call(this);
    this.element = element;

    // Monitor click on AddressBar
    var self = this;
    element.delegate('a', 'click', function () {
        //self.element.children('.active').removeClass('active');
        //$(this).parent().addClass('active');

        var dir = $(this).parent().attr('data-path');
        if (process.platform == 'win32' && dir == win32.MY_COMPUTER_PATH) {
            self.emit('select drive');
        }
        else {
            self.emit('navigate', dir);
        }

        return false;
    });
}

util.inherits(AddressBar, events.EventEmitter);

AddressBar.prototype.set = function (dirPath) {
    this.element.html(gen_bar({sequence: global.getPathData(dirPath)}));
}

AddressBar.prototype.selectDrive = function () {
    // 只需把路径缩短到只剩下我的电脑
    this.element.html(gen_bar({
        sequence: [{
            name: win32.MY_COMPUTER_NAME,
        }]
    }));
}

exports.AddressBar = AddressBar;
