var events = require('events');
var path = require('path');
var util = require('util');
var mime = require('mime');
if (process.platform == 'win32') {
    var win32 = require("win32");
}
var jade = require('jade');

// Template engine
var gen_files_view = jade.compile([
    '- each file in files',
    '  - if (file.type!="undefined")',
    '   .file(path="#{file.path}",type="#{file.type}")',
    '     .icon',
    '       img(src="icons/#{file.type}.png")',
    '     .name #{file.name}',
].join('\n'));

function Folder(jquery_element) {
    events.EventEmitter.call(this);
    this.element = jquery_element;

    var self = this;
    // Click on blank
    this.element.parent().on('click', function () {
        self.element.children('.focus').removeClass('focus');
    });
    // Click on file
    this.element.delegate('.file', 'click', function (e) {
        self.element.children('.focus').removeClass('focus');
        $(this).addClass('focus');
        e.stopPropagation();
    });
    // Double click on file
    this.element.delegate('.file', 'dblclick', function () {
        var file_path = $(this).attr('path');
        var type = $(this).attr('type');
        self.emit('navigate', file_path, type);
    });
}
util.inherits(Folder, events.EventEmitter);

Folder.prototype.open = function (dir) {
    var self = this;
    fs.readdir(dir, function (error, files) {
        if (error) {
            console.log(error);
            window.alert(error);
            return;
        }

        for (var i = 0; i < files.length; ++i) {
            files[i] = mime.stat(path.join(dir, files[i]));
        }

        self.element.html(gen_files_view({ files: files }));
    });
};

if (process.platform == 'win32') {
    Folder.prototype.selectDrive = function () {
        var self = this;
        win32.getDrives(function (drives) {
            for (var i = 0; i < drives.length; ++i) {
                drives[i] = mime.stat(drives[i]);
            }
            self.element.html(gen_files_view({ files: drives }));
        });
    };
};

exports.Folder = Folder;
