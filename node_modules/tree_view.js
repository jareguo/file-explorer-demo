var events = require('events');
var path = require('path');
var fs = require('fs');
var util = require('util');
var mime = require('mime');
if (process.platform == 'win32') {
    var win32 = require("win32");
}

function extendJstree(jstree) {
    jstree.find_node = function (parentNode, text) {
        var children = parentNode.children;
        if (children) {
            for (var i = 0; i < children.length; ++i) {
                var child = jstree.get_node(children[i]);
                if (child.text == text) {
                    return child;
                }
            }
        }
        return null;
    }
}

function Tree(jquery_element) {
    events.EventEmitter.call(this);

    jquery_element.jstree({                     // create instance
        'core' : {
            'check_callback' : true,            // always allows modify the structure of the tree
            'error' : console.error,
            'themes' : {
                'dots' : false,
                'responsive' : false,
            }
        }
    });

    this.jstree = jquery_element.jstree(true);  // get the existing instance after create
    this.element = jquery_element;
    var self = this;

    jquery_element.on('select_node.jstree'), function (e, data) {
        if (data.selected) {
            var file_path = data.selected.data('path');
            var type = data.selected.data('type');
            self.emit('navigate', file_path, type);
        }
    }
    extendJstree(this.jstree);
}
util.inherits(Tree, events.EventEmitter);

Tree.prototype.navigate = function (dir) {
    var pathes = global.getPathData(dir);
    var parsingNode = this.jstree.get_node(this.element);
    for (var i = 0; i < pathes.length; ++i) {
        // find sub node
        var nodeName = pathes[i].name;
        var node = this.jstree.find_node(parsingNode, nodeName);
        if (node) {
            // exists, open it
            parsingNode = node;
            if (node.children && node.children.length > 0) {
                this.jstree.open_node(node, null, false);
                continue;   // no need to create children
            }
        }
        else {
            // create it
            parsingNode = this.jstree.create_node(parsingNode, { text : nodeName }, "inside");
            if ( ! parsingNode) {
                console.error("failed to create node " + name + " parsingNode: " + parsingNode);
                return;
            };
        }
        // create children
        if (i + 1 < pathes.length) {
            var ignoreNavigateItem = pathes[i + 1].name;
        }
        if (win32 && pathes[i].path == win32.MY_COMPUTER_PATH) {
            this.createDrives(parsingNode, ignoreNavigateItem);
        }
        else {
            this.createFolders(parsingNode, pathes[i].path, ignoreNavigateItem);
        }
    }
};

Tree.prototype.createDrives = function (parentNode, ignoreItem) {
    var self = this;
    win32.getDrives(function (drives) {
        for (var i = 0; i < drives.length; ++i) {
            var driveName = drives[i];
            if (driveName != ignoreItem) {
                self.jstree.create_node(parentNode, { text : driveName }, "inside");
            }
        }
        self.jstree.open_node(parentNode, null, false);
    });
}

Tree.prototype.createFolders = function (parentNode, dir, ignoreItem) {
    var self = this;
    dir += path.sep;
    fs.readdir(dir, function (error, itemList) {
        if (error) {
            console.log(error);
            window.alert(error);
            return;
        }
        for (var i = 0; i < itemList.length; ++i) {
            var item = itemList[i];
            if (item != ignoreItem) {
                try {
                    var stat = fs.statSync(dir + item);
                }
                catch (e) {
                    continue;
                }
                if (stat.isDirectory()) {
                    self.jstree.create_node(parentNode, { text: item }, "inside");
                }
            }
        }
        self.jstree.open_node(parentNode, null, false);
    });
}

Tree.prototype.selectDrive = function () {
    // focus on my computer

};

exports.Tree = Tree;
