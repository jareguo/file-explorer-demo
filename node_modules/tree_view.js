var events = require('events');
var path = require('path');
var util = require('util');
var mime = require('mime');
if (process.platform == 'win32') {
    var win32 = require("win32");
}

function Tree(jquery_element) {
    events.EventEmitter.call(this);

    jquery_element.jstree({                     // create instance
        'core' : {
            'check_callback' : true,            // always allows modify the structure of the tree
            'error' : console.error,
            'themes' : {
                'dots' : false,
                'responsive' : false,
            }
        }
    });

    this.jstree = jquery_element.jstree(true);  // get the existing instance after create
    this.element = jquery_element;
    var self = this;

    jquery_element.on('select_node.jstree'), function (e, data) {
        if (data.selected) {
            var file_path = data.selected.data('path');
            var type = data.selected.data('type');
            self.emit('navigate', file_path, type);
        }
    }
    //this.jstree.
}
util.inherits(Tree, events.EventEmitter);

Tree.prototype.navigate = function (dir) {
    var pathes = global.getPathData(dir);
    var parsingNode = this.element;
    for (var i = 0; i < pathes.length; ++i) {
        // find sub node
        var subNode = this.jstree.get_children_dom(parsingNode).filter("#" + pathes[i].path);
        if (subNode) {
            // if exists, open it
            this.jstree.open_node(subNode, null, false);
        }
        else {
            // create it
            subNode = this.jstree.create_node(parsingNode, { text : pathes[i].name, id : pathes[i].path }, "inside");
        }
        parsingNode = subNode;
    }
    //var root = this.jstree.create_node(this.element, { text : pathes[0].name }, "inside");
    //this.jstree.create_node(root, { text: pathes[0].name }, "inside");
    //var self = this;
};

Tree.prototype.selectDrive = function () {
    // focus on my computer

};

exports.Tree = Tree;
